<!DOCTYPE html>
<html lang="en" ng-app="collageapp">
	<head>
		<title>Venice Missing Treasures Collage</title>
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
		
		<!-- Firebase -->
		<script type='text/javascript' src='https://cdn.firebase.com/v0/firebase.js'></script>
		
		<!-- jquery -->
		<!--[if lt IE 9]>
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
		<![endif]-->
		<!--[if (gte IE 9) | (!IE)]><!-->
		<!--script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js"></script-->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js" type="text/javascript"></script>
		<!--<![endif]-->
	
		<!--[if IE]>
		<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->
		
		<!-- Leaflet -->
		<script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
		
		<!-- bootstrap -->
		<!--link rel="stylesheet" type="text/css" href="css/bootstrap.min.css"/>
		<link rel="stylesheet" type="text/css" href="css/bootstrap-theme.min.css"/>
		<script type='text/javascript' src='js/bootstrap.min.js'></script-->
		
		<!-- angularjs -->
		<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.2.0/angular.min.js"></script>
		
		<!-- angular slider -->
		<!--link rel="stylesheet" type="text/css" href="css/angular-slider.min.css"/>
		<script type='text/javascript' src='js/angular-slider.min.js'></script>--
		
		<!-- spinner -->
		<!--script type='text/javascript' src='js/spin.min.js'></script>
		<script type='text/javascript' src='js/jquery.spin.js'></script-->
		
		<!-- local css -->
		<!--link rel="stylesheet" type="text/css" href="css/main.css"/-->
		
		<!-- console library -->
		<script type='text/javascript' src='javascripts/ck-console.js'></script>
		
		<link rel="stylesheet" type="text/css" href="css/transitions.css" media="all" />
		<link rel="stylesheet" type="text/css" href="css/collageTags.css" media="all" />
		<link rel="stylesheet" type="text/css" href="css/collageOverlay.css" media="all" />
	
		<script src="javascripts/jquery-collagePlus/jquery.collagePlus.js"></script>
		<script src="javascripts/jquery-collagePlus/jquery.removeWhitespace.js"></script>
		<script src="javascripts/jquery-collagePlus/jquery.collageCaption.js"></script>
		<script type="text/javascript" src="https://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
		<!--script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/fancybox/1.3.4/jquery.fancybox-1.3.4.pack.min.js"></script-->
	
		<script type="text/javascript">
			console.log("Loading Head script");
			// All images need to be loaded for this plugin to work so
			// we end up waiting for the whole window to load in this example
			$(window).load(function () {
				$(document).ready(function(){
					console.log("Document Ready");
					//collage();
					//$('.Collage').collageCaption();
				});
			});
		
		
			// Here we apply the actual CollagePlus plugin
			function collage() {
				$('.Collage').removeWhitespace().collagePlus(
					{
						'fadeSpeed'	 : 2000,
						'targetHeight'  : 250,
						'allowPartialLastRow' : true
					}
				);
			};
		
			// This is just for the case that the browser window is resized
			var resizeTimer = null;
			$(window).bind('resize', function() {
				// hide all the images until we resize them
				$('.Collage .Image_Wrapper').css("opacity", 0);
				// set a timer to re-apply the plugin
				if (resizeTimer) clearTimeout(resizeTimer);
				resizeTimer = setTimeout(collage, 200);
			});

		</script>
	</head>
	<body ng-controller="DataCtrl">
		<section class="Collage effect-parent">
			<div class="Image_Wrapper" data-caption="This is some data <u>with</u> html in it"><a>
				<img src="https://dummyimage.com/350x150/69D2E7/ffffff"></a></div>
			<div class="Image_Wrapper"><a><img src="https://dummyimage.com/320x180/A7DBD8/ffffff"></a></div>
			<div class="Image_Wrapper" data-caption="This is some data <u>with</u> html in it. Also a really long sentence with a <a href='http://www.bbc.co.uk'>link</a> in it"><a>
				<img src="https://dummyimage.com/320x300/E0E4CC/ffffff"></a></div>
			<div class="Image_Wrapper" data-caption="This is some data <u>with</u> html in it This is some data <u>with</u> html in it. Also a really long sentence with a <a href='https://www.bbc.co.uk'>link</a> in it This is some data <u>with</u>html in it. Also a really long sentence with a <a href='https://www.bbc.co.uk'>link</a> in it"><a>
				<img src="https://dummyimage.com/472x500/F38630/ffffff"></a></div>
			<div class="Image_Wrapper" data-caption="This is some data <u>with</u> html in it This is some data <u>with</u> html in it. Also a really long sentence with a <a href='https://www.bbc.co.uk'>link</a> in it"><a>
				<img src="https://dummyimage.com/540x360/FA6900/ffffff"></a></div>
			<div class="Image_Wrapper" data-caption="This is some data <u>with</u> html in it"><a><img src="https://dummyimage.com/800x600/ECD078/ffffff"></a></div>
			<div class="Image_Wrapper" data-caption="This is some data <u>with</u> html in it This is some data <u>with</u>html in it. Also a really long sentence with a <a href='https://www.bbc.co.uk'>link</a> in it"><a>
				<img src="https://dummyimage.com/400x120/D95B43/ffffff"></a></div>
			<div class="Image_Wrapper" data-caption="This is some data <u>with</u> html in it This is some data <u>with</u>html in it. Also a really long sentence with a <a href='https://www.bbc.co.uk'>link</a> in it"><a>
				<img src="https://dummyimage.com/300x300/C02942/ffffff"></a></div>
			<div class="Image_Wrapper" data-caption="This is some data <u>with</u> html in it"><a><img src="https://dummyimage.com/320x500/542437/ffffff"></a></div>
			<div class="Image_Wrapper" data-caption="This is some data <u>with</u> html in it"><a><img src="https://dummyimage.com/450x300/53777A/ffffff"></a></div>
		</section>
		<script type="text/javascript">
			//Function that truncates strings down to a specific length and adds '...' to the end
			String.prototype.trunc =
				function(n,useWordBoundary){
					var toLong = this.length>n,
					s_ = toLong ? this.substr(0,n-1) : this;
					s_ = useWordBoundary && toLong ? s_.substr(0,s_.lastIndexOf(' ')) : s_;
			 		return  toLong ? s_ + '&hellip;' : s_;
				};
				
			/*
			 * Holds the data to display for a given image in the collage
			 * @param {String} title The title of the peice of work
			 * @param {Number} date The date associated with this peice
			 * @param {String} caption The caption to display on this image
			 * @param {String} url The URL for the image to load
			 */
			function Image(title, date, caption, url){
				this.title = title;
				this.date = date;
				this.caption = caption;
				this.url = url;
				this.getImageDiv= function (){
					var image_wrapper = document.createElement('div');
					image_wrapper.setAttribute('class', 'Image_Wrapper');
					//Truncate the string to something under this lenght
					image_wrapper.setAttribute('data-caption', '<b>' + title + '</b><br>' + caption.trunc(100, true));
					var a = document.createElement('a');
					image_wrapper.appendChild(a);
					var image = document.createElement('img');
					image.setAttribute('src', url);
					a.appendChild(image);
					return image_wrapper;
				};
			}
			
			
			/*
			 * Hard coded images.
			 * This is done becasue we don't currenly have CK-console data entries
			 * for these peices.
			 */
			var images = [
				new Image('The Adoration of the Kings',
					1573,
					'The picture is dated 1573 in Roman numerals on the lowest step (bottom right). It was painted for the church of S. Silvestro in Venice, where it remained until the church was altered in the 19th century. It was not an altarpiece but a large painting for the wall of the nave beside the altar of the confraternity dedicated toSaint Joseph.',
					'https://upload.wikimedia.org/wikipedia/commons/2/20/Jan_Gossaert_001.jpg'),
				new Image('The Wedding at Cana',
					1563,
					'The piece was commissioned in 1562 by the Benedictine Monastery of San Giorgio Maggiore in Venice, Italy, and completed in fifteen months by the year 1563. It hung in the refectory of the monastery for 235 years, until it was plundered by Napoleonin 1797 and shipped to Paris. The painting was cut in half for the journey and stitched back together in Paris. It was not returned in the post-Napoleonic conciliation treaties which pursued some restitution of looted artworks',
					'https://upload.wikimedia.org/wikipedia/commons/e/e0/Paolo_Veronese_008.jpg'),
				new Image('Feast in the House of Levi',
					1573,
					'It was painted by Veronese for the rear wall of the refectory of the Basilica di Santi Giovanni e Paolo, a Dominican friary, as a Last Supper, to replace an earlier work by Titian destroyed in the fire of 1571.',
					'https://upload.wikimedia.org/wikipedia/commons/f/f1/Paolo_Veronese_007.jpg'),
				new Image('Enthroned Madonna and Child',
					1562,
					'Was painted for the Sacristy of the Venetian Renaissance church of San Zaccaria (restored in 1562). It is a fine example of the early works of Veronese with its harmonious richness of colour. Now in Accademia.',
					'https://upload.wikimedia.org/wikipedia/en/7/7f/Lippi_Madonna_Tarquinia.jpg'),
				new Image('Four Allegories of Love: Respect, Scorn, Unfaithfulness, Happy Union',
					1575,
					'They were probably made to decorate a ceiling and form a complete series. We do not know who commissioned them, but their presence in 1648 in the Prague Castle suggests that it may have been one of the Holy Roman Emperors, Ferdinand I (died 1564) or Maximilian II (died 1576), or a wealthy patron at the court. Alternatively, they may have been painted for a location in Venice, as two details from them are recorded in the famous sketchbook that Van Dyck kept in Italy between 1621 and 1627.',
					'https://upload.wikimedia.org/wikipedia/commons/b/b2/Paolo_Veronese_020.jpg'),
				new Image('The Family of Darius at the Feet of Alexander',
					1565,
					'In Venice at some point. Now in the National Gallery of London.',
					'https://upload.wikimedia.org/wikipedia/commons/5/56/Paolo_Veronese_-_The_Family_of_Darius_before_Alexander_-_Google_Art_Project.jpg')
					
			];
			
			//'collageapp' matches the 'ng-app' tag in the html tag
			app = angular.module('collageapp', ['ckServices']);
			//Note: You must have the body tag with ng-controller='DataCtrl' in order for this to work.
			app.controller('DataCtrl', ['$scope', '$compile', 'ckConsole', 'ckConsoleMap', '$http', function($scope, $compile, ckConsole, ckConsoleMap, $http){
				console.log('Controller for app loading');
				//Asks for a given data set from the ckConsole
				ckConsole.getGroup('Demolished Churches merge').then(
					/*
					 * This is called when the data from getGroup is returned.
					 * @param {Object} item This contains an object holding all of the individual elements from the given dataset
					 */
					function(item){
					/*
					 * XXX There has to be a better way to iterate over the elements stored
					 * in this 'item' object
					 */
					for (var property in item.members) {
						//This is the individual peice of data pulled form the list
						var church = item.members[property];
						console.log(church);
						
						//This is the id that the image url is stored behind
						var mediaID = church['merged-media-ids'].images['Demolished Churches Media'];
						//Create and add a new image to the image array using the church data
						images[images.length] = new Image(church.data.name,
							church.data.year_of_demolition,
							church.data.description,
							church.media.images[mediaID].original);
					}
					
					//Retrives the div that is holding the images
					var imageSection = document.getElementsByClassName('Collage effect-parent');
					//Iterates over the list of images and adds them to the existing div
					//TODO These images should really be lazy loaded
					for(var i = 0; i < images.length; i++){
						imageSection[0].appendChild(images[i].getImageDiv());
					}
					
					//Redraw the collage now that these images have been added
					//TODO Figure out a better place to do this
					collage();
					$('.Collage').collageCaption();
				});
			}]);
			
		</script>
	</body>
</html>	